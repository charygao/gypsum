BINARYCOMPATIBILITY_SRC_DIR := $(realpath $(dir $(lastword $(MAKEFILE_LIST))))

BINARYCOMPATIBILITY_PROGRAM := $(OUT_DIR)/BinaryCompatibility
TEST_PROGRAMS += $(BINARYCOMPATIBILITY_PROGRAM)
BINARYCOMPATIBILITY_SOURCES := $(BINARYCOMPATIBILITY_SRC_DIR)/BinaryCompatibility.cpp
BINARYCOMPATIBILITY_OBJECTS := $(call objects,$(BINARYCOMPATIBILITY_SOURCES))

BINARYCOMPATIBILITY_FOO_PACKAGE := $(OUT_DIR)/binarycompatibility.foo-1.csp
BINARYCOMPATIBILITY_BAR_1_PACKAGE := $(OUT_DIR)/binarycompatibility-old/binarycompatibility.bar-1.csp
BINARYCOMPATIBILITY_BAR_2_PACKAGE := $(OUT_DIR)/binarycompatibility-new/binarycompatibility.bar-2.csp

BINARYCOMPATIBILITY_PACKAGES := \
  $(BINARYCOMPATIBILITY_FOO_PACKAGE) \
  $(BINARYCOMPATIBILITY_BAR_1_PACKAGE) \
  $(BINARYCOMPATIBILITY_BAR_2_PACKAGE)

TEST_PROGRAM_SOURCES += $(BINARYCOMPATIBILITY_SOURCES)
TEST_PROGRAM_OBJECTS += $(BINARYCOMPATIBILITY_OBJECTS)

$(BINARYCOMPATIBILITY_PROGRAM): $(BINARYCOMPATIBILITY_OBJECTS) $(LIB) $(BINARYCOMPATIBILITY_PACKAGES)

$(BINARYCOMPATIBILITY_FOO_PACKAGE): $(GY_COMPILER) $(BINARYCOMPATIBILITY_SRC_DIR)/foo.gy $(BINARYCOMPATIBILITY_BAR_1_PACKAGE) $(STD_PACKAGE)
	@mkdir -p $(dir $@)
	$(GY_COMPILE) -p binarycompatibility.foo -v 1 $(filter %.gy,$^) -P $(dir $(BINARYCOMPATIBILITY_BAR_1_PACKAGE)) -o $@

$(BINARYCOMPATIBILITY_BAR_1_PACKAGE): $(GY_COMPILER) $(BINARYCOMPATIBILITY_SRC_DIR)/bar-1.gy $(STD_PACKAGE)
	@mkdir -p $(dir $@)
	$(GY_COMPILE) -p binarycompatibility.bar -v 1 $(filter %.gy,$^) -o $@

$(BINARYCOMPATIBILITY_BAR_2_PACKAGE): $(GY_COMPILER) $(BINARYCOMPATIBILITY_SRC_DIR)/bar-2.gy $(STD_PACKAGE)
	@mkdir -p $(dir $@)
	$(GY_COMPILE) -p binarycompatibility.bar -v 2 $(filter %.gy,$^) -o $@

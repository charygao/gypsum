NATIVECALLS_SRC_DIR := $(realpath $(dir $(lastword $(MAKEFILE_LIST))))

NATIVECALLS_PROGRAM := $(OUT_DIR)/NativeCalls
TEST_PROGRAMS += $(NATIVECALLS_PROGRAM)
NATIVECALLS_SOURCES := $(NATIVECALLS_SRC_DIR)/NativeCalls.cpp
NATIVECALLS_OBJECTS := $(call objects,$(NATIVECALLS_SOURCES))

NATIVECALLS_SHAREDLIB := $(OUT_DIR)/libNativeCalls.sharedlib-1$(SHARED_LIB_SUFFIX)
NATIVECALLS_SHAREDLIB_CXX_SOURCES := $(NATIVECALLS_SRC_DIR)/sharedlib.cpp
NATIVECALLS_SHAREDLIB_OBJECTS := $(call objects,$(NATIVECALLS_SHAREDLIB_CXX_SOURCES))
NATIVECALLS_SHAREDLIB_GY_SOURCES := $(NATIVECALLS_SRC_DIR)/sharedlib.gy

NATIVECALLS_STATICLIB := $(OUT_DIR)/libNativeCalls.staticlib-1$(STATIC_LIB_SUFFIX)
NATIVECALLS_STATICLIB_CXX_SOURCES := $(NATIVECALLS_SRC_DIR)/staticlib.cpp
NATIVECALLS_STATICLIB_OBJECTS := $(call objects,$(NATIVECALLS_STATICLIB_CXX_SOURCES))
NATIVECALLS_STATICLIB_GY_SOURCES := $(NATIVECALLS_SRC_DIR)/staticlib.gy

NATIVECALLS_REGISTERED_GY_SOURCES := $(NATIVECALLS_SRC_DIR)/registered.gy

NATIVECALLS_PACKAGES := $(OUT_DIR)/NativeCalls.sharedlib-1.csp \
  $(OUT_DIR)/NativeCalls.staticlib-1.csp \
  $(OUT_DIR)/NativeCalls.registered-1.csp

TEST_PROGRAM_SOURCES += $(NATIVECALLS_SOURCES) \
  $(NATIVECALLS_SHAREDLIB_CXX_SOURCES) \
  $(NATIVECALLS_STATICLIB_CXX_SOURCES)
TEST_PROGRAM_OBJECTS += $(NATIVECALLS_OBJECTS) \
  $(NATIVECALLS_SHAREDLIB_OBJECTS) \
  $(NATIVECALLS_STATICLIB_OBJECTS)
TEST_PROGRAM_SHARED_LIBS += $(NATIVECALLS_SHAREDLIB)
TEST_PROGRAM_STATIC_LIBS += $(NATIVECALLS_STATICLIB)

$(NATIVECALLS_PROGRAM): LDFLAGS += -rdynamic

$(NATIVECALLS_PROGRAM): $(NATIVECALLS_OBJECTS) \
    $(LIB) \
    $(NATIVECALLS_SHAREDLIB) \
    $(NATIVECALLS_STATICLIB) \
    $(NATIVECALLS_PACKAGES)

$(NATIVECALLS_SHAREDLIB): $(NATIVECALLS_SHAREDLIB_OBJECTS)

$(NATIVECALLS_STATICLIB): $(NATIVECALLS_STATICLIB_OBJECTS)

$(OUT_DIR)/NativeCalls.sharedlib-1.csp: $(NATIVECALLS_SHAREDLIB_GY_SOURCES) $(STD_PACKAGE)
	@mkdir -p $(dir $@)
	$(GY_COMPILE) -p NativeCalls.sharedlib -v 1 $< -o $@

$(OUT_DIR)/NativeCalls.staticlib-1.csp: $(NATIVECALLS_STATICLIB_GY_SOURCES) $(STD_PACKAGE)
	@mkdir -p $(dir $@)
	$(GY_COMPILE) -p NativeCalls.staticlib -v 1 $< -o $@

$(OUT_DIR)/NativeCalls.registered-1.csp: $(NATIVECALLS_REGISTERED_GY_SOURCES) $(STD_PACKAGE)
	@mkdir -p $(dir $@)
	$(GY_COMPILE) -p NativeCalls.registered -v 1 $< -o $@
